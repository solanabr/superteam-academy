# Superteam Academy — Security Fixes, Testing Expansion & Credential Tests

## Phase 1: Critical Security — Enrollment PDA Seed Constraints

### Problem
Enrollment PDAs are created with seeds `["enrollment", course_id, learner]` in `enroll.rs`, but ALL other instructions that reference enrollment accounts have NO seed constraints — only `enrollment.course == course.key()`. This means any enrollment for the same course can be substituted.

### Fix
Add proper `seeds + bump` constraints to enrollment accounts in 4 instructions:

**1a. `complete_lesson.rs`** — Add seeds using `course.course_id`:
```rust
#[account(
    mut,
    seeds = [b"enrollment", course.course_id.as_bytes(), learner.key().as_ref()],
    bump = enrollment.bump,
    constraint = enrollment.course == course.key() @ AcademyError::EnrollmentCourseMismatch,
)]
pub enrollment: Account<'info, Enrollment>,
```

**1b. `finalize_course.rs`** — Same pattern.

**1c. `issue_credential.rs`** — Same pattern.

**1d. `close_enrollment.rs`** — Needs a Course account added (currently only has `enrollment.course` pubkey). Add read-only Course account + enrollment PDA seeds:
```rust
pub course: Account<'info, Course>,
#[account(
    mut,
    seeds = [b"enrollment", course.course_id.as_bytes(), learner.key().as_ref()],
    bump = enrollment.bump,
    close = learner,
)]
pub enrollment: Account<'info, Enrollment>,
```

## Phase 2: Other Security Fixes

**2a.** `finalize_course.rs` line 66: `completed * course.xp_per_lesson` overflow → use `checked_mul`

**2b.** `issue_credential.rs` upgrade path: `courses_completed` uses `course.total_completions` (global) instead of learner's count → use `course.track_level` as a more meaningful attribute

## Phase 3: Metaplex Core Credential Testing

**3a.** Clone Metaplex Core program from mainnet:
```bash
solana program dump CoREENxT6tW1HoK8ypY1SxRMZTcVPm7R94rH4PZNhX7d tests/fixtures/mpl_core.so
```

**3b.** Add `[test.validator]` section to `Anchor.toml`

**3c.** Install `@metaplex-foundation/mpl-core` + UMI packages

**3d.** Write credential test suite:
- Create track collection (Config PDA as authority)
- Issue credential (CREATE path): verify soulbound NFT, attributes, frozen
- Issue credential (UPGRADE path): verify URI + attributes update
- Error: credential on unfinalized enrollment
- Error: wrong credential_asset on upgrade
- Error: wrong learner

## Phase 4: Expanded TS Integration Tests

- Close enrollment by wrong learner (should fail after PDA fix)
- Complete lesson with mismatched learner/enrollment (should fail after PDA fix)
- Finalize with zero bonus_xp and zero creator_reward_xp
- Course with 1 lesson (boundary)
- Course with max lessons (255)
- XP token account for wrong owner
- Prerequisite enrollment that was closed (PDA no longer exists)
- Event emission checks

## Phase 5: Rewrite Rust LiteSVM Tests

Current Rust tests reference removed features (LearnerProfile, init_learner, etc.) — 47 stale references, cannot compile. Full rewrite to match current 9-instruction, 3-PDA program.

## Phase 6: Fuzz Test Improvements

- Add enrollment PDA seed validation invariants
- Add XP overflow edge cases
- Strengthen post-sequence invariant checks
