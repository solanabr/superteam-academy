name: CI

on:
  push:
    branches: [main, feat/**]
  pull_request:
    branches: [main]

jobs:
  type-check:
    name: TypeScript
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      - run: npm ci --legacy-peer-deps
      - run: npm run type-check

  lint:
    name: ESLint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      - run: npm ci --legacy-peer-deps
      - run: npm run lint

  build:
    name: Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    env:
      NEXT_PUBLIC_GA_ID: ${{ secrets.NEXT_PUBLIC_GA_ID }}
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
      NEXT_PUBLIC_SOLANA_RPC: ${{ secrets.NEXT_PUBLIC_SOLANA_RPC }}
      NEXTAUTH_SECRET: 'ci-build-secret-not-for-production'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      - run: npm ci --legacy-peer-deps
      - run: npm run build

  e2e:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [build]
    defaults:
      run:
        working-directory: app
    env:
      NEXTAUTH_SECRET: 'ci-e2e-secret-not-for-production'
      NEXTAUTH_URL: 'http://localhost:3000'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      - run: npm ci --legacy-peer-deps
      - run: npx playwright install --with-deps chromium
      - run: npm run build
      - name: Run Playwright tests
        run: npm test
        env:
          CI: 'true'
          PLAYWRIGHT_BASE_URL: 'http://localhost:3000'
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: app/playwright-report/
          retention-days: 7

  anchor-tests:
    name: Anchor / Rust Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: onchain-academy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: '1.85.0'
          targets: wasm32-unknown-unknown
      - name: Install Anchor CLI
        run: npm install -g @coral-xyz/anchor-cli@0.31.1
      - name: Run Rust unit tests
        run: cargo test --manifest-path tests/rust/Cargo.toml
      - name: Build Anchor program
        run: anchor build
